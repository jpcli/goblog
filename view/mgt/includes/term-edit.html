{{ define "include" }}

<form class="layui-form" lay-filter="term-form" action="">
	<div class="layui-form-item">
		<label class="layui-form-label">类型</label>
		<div class="layui-input-block">
			<input type="text" name="type" required lay-verify="required" autocomplete="off"
				class="layui-input layui-disabled" disabled>
		</div>
	</div>

	<div class="layui-form-item">
		<label class="layui-form-label">名字</label>
		<div class="layui-input-block">
			<input type="text" name="name" required lay-verify="required" placeholder="请输入名字" autocomplete="off"
				class="layui-input">
		</div>
	</div>

	<div class="layui-form-item">
		<label class="layui-form-label">缩略名</label>
		<div class="layui-input-block">
			<input type="text" name="slug" id="slug" required lay-verify="required" placeholder="请输入缩略名"
				autocomplete="off" class="layui-input">
		</div>
	</div>

	<div class="layui-form-item layui-form-text">
		<label class="layui-form-label">描述</label>
		<div class="layui-input-block">
			<textarea name="description" placeholder="请输入描述" class="layui-textarea" style="height:100px"></textarea>
		</div>
	</div>

	<div class="layui-form-item">
		<div class="layui-input-block">
			<button class="layui-btn" lay-submit lay-filter="form-submit">立即提交</button>
		</div>
	</div>
</form>

<script>
	//获取窗口索引（通过layer打开本网页）
	iframeIndex = parent.layer.getFrameIndex(window.name); 
	
	search = layui.url().search
	termType = search.type
	id = search.id
	canSubmit = true

	layui.use(['form'], function() {
		form = layui.form;
		
		// 类型框显示为中文
		let tmp = ""
		if (termType == "category") tmp = "分类"
		else if (termType == "tag") tmp = "标签"
		form.val("term-form", {
			"type": tmp,
		});
		
		// 监听提交
		form.on('submit(form-submit)', function(data) {
			if (!canSubmit) {
				layer.msg('正在提交中，请稍后', {
					icon: 2,
					time: 1000
				});
				return false
			}
			
			// 提交修改请求
			let d = data.field
			d.type = termType
			editTerm(id, d)
			
			// 不跳转
			return false;
		});
		
		// 非新建则获取term信息
		if (id != 0) {
			getTerm(id)
		}
	});

	// 获取term
	function getTerm(tid) {
		fetch(`../api/getTerm?id=${tid}`, {
				method: "POST"
			})
			.then(res => {
				return res.json()
			})
			.then(res => {
				if (res.code) {
					layer.msg(`错误：${res.err}`, {
						icon: 2,
						end: function() {
							// 关闭当前弹出窗口
							parent.layer.close(iframeIndex)
						}
					});
					return
				}

				// 表单赋值
				form.val("term-form", {
					"name": res.data.name,
					"slug": res.data.slug,
					"description": res.data.description,
				});

				// 锁定slug框
				document.querySelector("#slug").className += ' layui-disabled'
				document.querySelector("#slug").setAttribute('disabled', "")
			})
	}

	// 提交term修改
	function editTerm(tid, data) {
		// lock
		canSubmit = false

		fetch(`../api/editTerm?id=${tid}`, {
				method: "POST",
				headers: new Headers({
					'Accept': 'application/json' // 通过头指定，获取的数据类型是JSON
				}),
				body: JSON.stringify(data)
			})
			.then(res => {
				return res.json()
			})
			.then(res => {
				if (!res.code) {
					layer.msg('提交成功', {
						icon: 1,
						time: 1000,
						end: function() {
							// 刷新父级窗口表格
							parent.reloadTable()
							// 关闭当前弹出窗口
							parent.layer.close(iframeIndex)
						}
					});
				} else {
					// 修改失败
					layer.msg(`错误：${res.err}`, {
						icon: 2
					});
				}
				
				// unlock
				canSubmit = true
			})
	}
</script>


{{ end }}
