{{ define "include" }}

<form class="layui-form" lay-filter="post-form" action="">
	<div class="layui-form-item">
		<label class="layui-form-label">标题</label>
		<div class="layui-input-block">
			<input type="text" name="title" required lay-verify="required" placeholder="请输入标题" autocomplete="off"
				class="layui-input">
		</div>
	</div>

	<div class="layui-form-item">
		<label class="layui-form-label">分类</label>
		<div class="layui-input-block">
			<select name="category" id="category" lay-verify="required">
				<option value="">请选择分类</option>
				<option value="0">123</option>

			</select>
		</div>
	</div>

	<div class="layui-form-item">
		<label class="layui-form-label">标签</label>
		<div id="tags" name="tags"></div>
	</div>

	<div class="layui-form-item">
		<label class="layui-form-label">关键词</label>
		<div class="layui-input-block">
			<input type="text" name="keywords" required lay-verify="required" placeholder="以英文逗号分割" autocomplete="off"
				class="layui-input" id="keywords">
			<div class="layui-form-mid" id="keywords-display"></div>
		</div>
	</div>

	<!-- <div class="layui-form-item layui-form-text">
		<label class="layui-form-label">描述</label>
		<div class="layui-input-block">
			<textarea name="description" required lay-verify="required" placeholder="请输入描述内容" class="layui-textarea"
				style="height:50px"></textarea>
		</div>
	</div> -->


	<div class="layui-form-item">
		<label class="layui-form-label">允许评论</label>
		<div class="layui-input-block">
			<input type="checkbox" name="commentAllow" lay-skin="switch" lay-text="开启|关闭" checked>
		</div>
	</div>

	<div class="layui-form-item layui-form-text">
		<label class="layui-form-label">正文</label>
		<div class="layui-input-block">
			<textarea name="postText" placeholder="请输入内容" class="layui-textarea" style="height:400px"></textarea>
		</div>
	</div>

	<div class="layui-form-item">
		<div class="layui-input-block">
			<button class="layui-btn" lay-submit lay-filter="form-submit">立即提交</button>
		</div>
	</div>
</form>

<script>
	//获取窗口索引（通过layer打开本网页）
	iframeIndex = parent.layer.getFrameIndex(window.name);


	nowPostID = layui.url()
	.search.id
	nowPostID = nowPostID ? nowPostID : 0
	canSubmit = true

	layui.use(['form', 'transfer'], function() {
		form = layui.form
		transfer = layui.transfer

		// 穿梭框渲染
		transfer.render({
			elem: '#tags',
			height: 200,
			data: [],
			id: 'transfer-tag', //定义索引
			title: ['未选中', '已选中'],
			showSearch: true,
			parseData: function(res) {
				return {
					"value": res.tid,
					"title": res.name,
					"disabled": res.disabled,
					"checked": res.checked
				}
			}
		})

		// 监听提交
		form.on('submit(form-submit)', function(data) {
			// 判定提交锁定
			if (!canSubmit) {
				layer.msg('正在提交中，请稍后', {
					icon: 2,
					time: 1000
				})
				return false
			}

			let d = data.field // 数据copy
			d.commentAllow = d.commentAllow ? 1 : 0
			// 包装category
			d.category = {
				tid: parseInt(d.category)
			}
			// 包装tags
			let t = transfer.getData('transfer-tag')
			d.tags = []
			for (let i = 0, len = t.length; i < len; i++) {
				d.tags.push({
					tid: parseInt(t[i].value)
				})
			}
			// 包装text
			d.text = d.postText
			delete d.postText

			console.log(d)
			// 提交修改请求
			editPost(d)

			// 不跳转
			return false;
		})

		getPost()
	})

	// 获取post
	function getPost() {
		// TODO:请求阻塞或失败时的处理
		fetch(`../api/getPost?id=${nowPostID}`, {
				method: "POST"
			})
		.then(res => {
			return res.json()
		})
		.then(res => {
			if (res.code) {
				layer.msg(`错误：${res.msg}`, {
					icon: 2,
					end: function() {
						// 关闭当前弹出窗口
						parent.layer.close(iframeIndex)
					}
				})
				return
			}

			// 重载标签穿梭框
			let tagsValue = []
			t = []
			if (res.data.post && res.data.post.tags) {
				t = res.data.post.tags
			}
			for (let i = 0, len = t.length; i < len; i++) {
				tagsValue.push(t[i].tid)
			}
			transfer.reload('transfer-tag', {
				data: res.data.allTags,
				value: tagsValue,
			})

			// 重载分类下拉框
			let h = `<option value="">请选择分类</option>`
			for (let i = 0, c = res.data.allCategories, len = c.length; i < len; i++) {
				h += `<option value="${c[i].tid}">${c[i].name}</option>`
			}
			document.querySelector("#category")
			.innerHTML = h
			form.render('select', 'post-form');

			// 若非新增，进行表单赋值
			if (nowPostID != 0) {
				p = res.data.post
				form.val("post-form", {
					"title": p.title,
					"commentAllow": p.commentAllow,
					"postText": p.text,
					"category": p.category.tid,
					"keywords": p.keywords,
					// "description": p.description
				})
				displayKeywords()
			}
		})
	}

	// 提交post修改
	function editPost(data) {
		// 加锁
		canSubmit = false

		// TODO: 请求阻塞或失败的回调
		fetch(`../api/editPost?id=${nowPostID}`, {
				method: "POST",
				headers: new Headers({
					'Accept': 'application/json' // 通过头指定，获取的数据类型是JSON
				}),
				body: JSON.stringify(data)
			})
		.then(res => {
			return res.json()
		})
		.then(res => {
			if (!res.code) {
				// 修改成功
				layer.msg('提交成功', {
					icon: 1,
					time: 1000,
					end: function() {
						// 刷新父级窗口表格
						parent.reloadTable()
						// 关闭当前弹出窗口
						parent.layer.close(iframeIndex)
					}
				})
			} else {
				// 修改失败
				layer.msg(`错误：${res.msg}`, {
					icon: 2
				})
			}
			// unlock
			canSubmit = true
		})
	}


	// 关键词实时分割显示
	function displayKeywords() {
		let keywords = document.querySelector("#keywords")
		.value.split(","),
		t = ""
		for (let i = 0, len = keywords.length; i < len; i++) {
			t += `<span class="layui-badge layui-bg-green">${keywords[i]}</span>\n`
		}
		document.querySelector("#keywords-display")
		.innerHTML = t
	}
	document.querySelector("#keywords")
	.addEventListener("input", displayKeywords)
</script>


{{ end }}
