<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0" />
        <title>文章列表</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sentsin/layui@v2.6.5/dist/css/layui.css" />
        <script src="https://cdn.jsdelivr.net/gh/sentsin/layui@v2.6.5/dist/layui.js" type="text/javascript" charset="utf-8"></script>
        <style>
            body {
                background-color: #f2f2f2;
                padding: 15px;
            }
        </style>
    </head>
    <body>
        <div class="layui-card">
            <!-- TODO: 在card的header中添加按指定id搜索功能等，参考https://www.layui.com/layuiadmin/std/dist/views/app/content/list.html -->
            <div class="layui-card-header">卡片面板</div>
            <div class="layui-card-body">
                <button type="button" class="layui-btn" id="btn-new-post">
                    <i class="layui-icon layui-icon-add-circle-fine"></i>
                    新建文章
                </button>
                <table id="list-table" lay-filter="list-table"></table>
            </div>
        </div>

        <script type="text/html" id="tool-bar">
            <button class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit">
                <i class="layui-icon layui-icon-edit"></i>
                编辑
            </button>
            <button class="layui-btn layui-btn-xs" lay-filter="opt-status" data-id="{{ d.id }}" data-status="{{ d.status }}">
                <i class="layui-icon layui-icon-tabs"></i>
                操作
                <i class="layui-icon layui-icon-triangle-d"></i>
            </button>
        </script>

        <script type="text/javascript">
            // 监听“新建文章”按钮
            document.querySelector("#btn-new-post").addEventListener("click", function () {
                openEditer(0, "新建文章")
            })

            // 打开文章编辑页弹窗
            function openEditer(id, title) {
                layer.open({
                    type: 2,
                    area: ["1000px", "700px"],
                    title: title,
                    content: `edit.html?id=${id}`,
                })
            }

            // 刷新表格
            function reloadTable() {
                table.reload("list-table")
            }

            layui.use(function () {
                table = layui.table
                dropdown = layui.dropdown
                $ = layui.$

                // 表格渲染
                table.render({
                    elem: "#list-table",
                    id: "list-table",
                    url: "../../api/post/list/normal", //数据接口
                    method: "GET",
                    page: true, //开启分页
                    cols: [
                        [
                            //表头
                            { field: "id", title: "ID", sort: true, fixed: "left", width: 70 },
                            { field: "title", title: "标题" },
                            {
                                field: "modified",
                                title: "最后修改时间",
                                width: 170,
                                templet: d => {
                                    return layui.util.toDateString(d.modified * 1000, "yyyy-MM-dd HH:mm:ss")
                                },
                            },
                            {
                                field: "category",
                                title: "分类",
                                width: 130,
                                templet: d => {
                                    return d.category
                                },
                            },
                            {
                                field: "tags",
                                title: "标签",
                                width: 300,
                                templet: d => {
                                    // let tags = []
                                    // if (d.tags != null) {
                                    //     for (let i = 0, len = d.tags.length; i < len; i++) {
                                    //         tags.push(d.tags[i])
                                    //     }
                                    // }
                                    return d.tags.join(" , ")
                                },
                            },
                            {
                                field: "Status",
                                title: "状态",
                                align: "center",
                                width: 100,
                                templet: d => {
                                    switch (d.status) {
                                        case 1:
                                            return `<span class="layui-badge layui-bg-green">发布</span>`
                                        case 2:
                                            return `<span class="layui-badge layui-bg-blue">置顶</span>`
                                        // case 3: 删除
                                    }
                                },
                            },
                            { title: "操作", width: 300, align: "center", fixed: "right", toolbar: "#tool-bar" },
                        ],
                    ],
                    parseData: res => {
                        //res 即为原始返回的数据，该函数解析原始数据为表格接受的数据
                        let data = []
                        for (let i = 0; i < res.data.list.length; i++) {
                            let post = res.data.list[i].post
                            let tmp = {
                                id: post.Pid,
                                title: post.Title,
                                modified: post.Modified,
                                status: post.Status,
                                category: res.data.list[i].category.Name,
                                tags: [],
                            }
                            let tags = res.data.list[i].tags
                            for (let j = 0; tags != null && j < tags.length; j++) {
                                tmp.tags.push(tags[j].Name)
                            }
                            data.push(tmp)
                        }
                        return {
                            code: res.code,
                            msg: res.msg,
                            count: res.data.total,
                            data: data,
                        }
                    },
                    done: res => {
                        suiteDropdown()
                    },
                })

                // 监听表格排序
                table.on("sort(list-table)", () => {
                    suiteDropdown()
                })

                // 表格行工具栏监听
                table.on("tool(list-table)", obj => {
                    let data = obj.data, // 获得当前行数据
                        layEvent = obj.event, // 获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
                        tr = obj.tr // 获得当前行 tr 的 DOM 对象（如果有的话）

                    let id = data.id
                    if (layEvent === "edit") {
                        openEditer(id, `编辑文章【${id}】`)
                    }
                })

                // 下拉菜单重载
                function suiteDropdown() {
                    dropdown.render({
                        elem: "[lay-filter='opt-status']",
                        data: [
                            { title: "正常发布", id: "1" },
                            { title: "文章置顶", id: "2" },
                        ],
                        click: function (data, othis) {
                            let elem = $(this.elem),
                                from_status_id = elem.data("status"),
                                to_status_id = data.id,
                                post_id = elem.data("id")
                            if (from_status_id != to_status_id) {
                                layer.msg("发送请求")
                                setStatus(post_id, to_status_id)
                            } else {
                                layer.msg("状态相同，无需更改")
                            }
                        },
                    })
                }

                // 更改文章状态
                function setStatus(id, status) {
                    fetch(`../../api/post/status/${id}`, {
                        method: "PATCH",
                        headers: new Headers({
                            Accept: "application/json", // 通过头指定，获取的数据类型是JSON
                        }),
                        body: JSON.stringify({ status: parseInt(status) }),
                    })
                        .then(res => {
                            return res.json()
                        })
                        .then(res => {
                            if (res.code) {
                                layer.msg(`错误：${res.msg}`, { icon: 2 })
                            } else {
                                reloadTable()
                                layer.msg(`修改成功`, { icon: 1 })
                            }
                        })
                }
            })
        </script>
    </body>
</html>
